!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t():"function"==typeof define&&define.amd?define(t):t()}(0,function(){"use strict";const e="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},t=Symbol("@@webxr-polyfill/EventTarget");class r{constructor(){this[t]={listeners:new Map}}addEventListener(e,r){if("string"!=typeof e)throw new Error("`type` must be a string");if("function"!=typeof r)throw new Error("`listener` must be a function");const i=this[t].listeners.get(e)||[];i.push(r),this[t].listeners.set(e,i)}removeEventListener(e,r){if("string"!=typeof e)throw new Error("`type` must be a string");if("function"!=typeof r)throw new Error("`listener` must be a function");const i=this[t].listeners.get(e)||[];for(let e=i.length;e>=0;e--)i[e]===r&&i.pop()}dispatchEvent(e,r){const i=this[t].listeners.get(e)||[],s=[];for(let e=0;e<i.length;e++)s[e]=i[e];for(let e of s)e(r);"function"==typeof this[`on${e}`]&&this[`on${e}`](r)}}const i=Symbol("@@webxr-polyfill/XR"),s="Polyfill Error: Must call navigator.xr.isSessionSupported() with any XRSessionMode\nor navigator.xr.requestSession('inline') prior to requesting an immersive\nsession. This is a limitation specific to the WebXR Polyfill and does not apply\nto native implementations of the API.";let n;if("performance"in e==!1){let e=Date.now();n=(()=>Date.now()-e)}else n=(()=>performance.now());var a=n;const o=Symbol("@@webxr-polyfill/XRPose");class h{constructor(e,t){this[o]={transform:e,emulatedPosition:t}}get transform(){return this[o].transform}get emulatedPosition(){return this[o].emulatedPosition}_setTransform(e){this[o].transform=e}}const l=1e-6;let c="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function d(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function u(e,t){let r=t[0],i=t[1],s=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],d=t[9],u=t[10],_=t[11],p=t[12],f=t[13],m=t[14],g=t[15],w=r*o-i*a,b=r*h-s*a,v=r*l-n*a,y=i*h-s*o,E=i*l-n*o,R=s*l-n*h,A=c*f-d*p,M=c*m-u*p,x=c*g-_*p,S=d*m-u*f,T=d*g-_*f,I=u*g-_*m,C=w*I-b*T+v*S+y*x-E*M+R*A;return C?(C=1/C,e[0]=(o*I-h*T+l*S)*C,e[1]=(s*T-i*I-n*S)*C,e[2]=(f*R-m*E+g*y)*C,e[3]=(u*E-d*R-_*y)*C,e[4]=(h*x-a*I-l*M)*C,e[5]=(r*I-s*x+n*M)*C,e[6]=(m*v-p*R-g*b)*C,e[7]=(c*R-u*v+_*b)*C,e[8]=(a*T-o*x+l*A)*C,e[9]=(i*x-r*T-n*A)*C,e[10]=(p*E-f*v+g*w)*C,e[11]=(d*v-c*E-_*w)*C,e[12]=(o*M-a*S-h*A)*C,e[13]=(r*S-i*M+s*A)*C,e[14]=(f*b-p*y-m*w)*C,e[15]=(c*y-d*b+u*w)*C,e):null}function _(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],d=t[8],u=t[9],_=t[10],p=t[11],f=t[12],m=t[13],g=t[14],w=t[15],b=r[0],v=r[1],y=r[2],E=r[3];return e[0]=b*i+v*o+y*d+E*f,e[1]=b*s+v*h+y*u+E*m,e[2]=b*n+v*l+y*_+E*g,e[3]=b*a+v*c+y*p+E*w,b=r[4],v=r[5],y=r[6],E=r[7],e[4]=b*i+v*o+y*d+E*f,e[5]=b*s+v*h+y*u+E*m,e[6]=b*n+v*l+y*_+E*g,e[7]=b*a+v*c+y*p+E*w,b=r[8],v=r[9],y=r[10],E=r[11],e[8]=b*i+v*o+y*d+E*f,e[9]=b*s+v*h+y*u+E*m,e[10]=b*n+v*l+y*_+E*g,e[11]=b*a+v*c+y*p+E*w,b=r[12],v=r[13],y=r[14],E=r[15],e[12]=b*i+v*o+y*d+E*f,e[13]=b*s+v*h+y*u+E*m,e[14]=b*n+v*l+y*_+E*g,e[15]=b*a+v*c+y*p+E*w,e}function p(){let e=new c(3);return c!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function f(e,t,r){let i=new c(3);return i[0]=e,i[1]=t,i[2]=r,i}function m(e,t,r){let i=t[0],s=t[1],n=t[2],a=r[0],o=r[1],h=r[2];return e[0]=s*h-n*o,e[1]=n*a-i*h,e[2]=i*o-s*a,e}const g=function(e){let t=e[0],r=e[1],i=e[2];return Math.sqrt(t*t+r*r+i*i)};!function(){let e=p()}();!function(){let e=function(){let e=new c(4);return c!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}()}();function w(){let e=new c(4);return c!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function b(e,t,r,i){let s,n,a,o,h,c=t[0],d=t[1],u=t[2],_=t[3],p=r[0],f=r[1],m=r[2],g=r[3];return(n=c*p+d*f+u*m+_*g)<0&&(n=-n,p=-p,f=-f,m=-m,g=-g),1-n>l?(s=Math.acos(n),a=Math.sin(s),o=Math.sin((1-i)*s)/a,h=Math.sin(i*s)/a):(o=1-i,h=i),e[0]=o*c+h*p,e[1]=o*d+h*f,e[2]=o*u+h*m,e[3]=o*_+h*g,e}const v=function(e,t,r,i){let s=new c(4);return s[0]=e,s[1]=t,s[2]=r,s[3]=i,s},y=function(e,t){let r=t[0],i=t[1],s=t[2],n=t[3],a=r*r+i*i+s*s+n*n;return a>0&&(a=1/Math.sqrt(a),e[0]=r*a,e[1]=i*a,e[2]=s*a,e[3]=n*a),e},E=(function(){let e=p(),t=f(1,0,0),r=f(0,1,0)}(),function(){let e=w(),t=w()}(),function(){let e=function(){let e=new c(9);return c!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}()}(),Symbol("@@webxr-polyfill/XRRigidTransform"));class R{constructor(){if(this[E]={matrix:null,position:null,orientation:null,inverse:null},0===arguments.length)this[E].matrix=d(new Float32Array(16));else if(1===arguments.length)arguments[0]instanceof Float32Array?this[E].matrix=arguments[0]:(this[E].position=this._getPoint(arguments[0]),this[E].orientation=DOMPointReadOnly.fromPoint({x:0,y:0,z:0,w:1}));else{if(2!==arguments.length)throw new Error("Too many arguments!");this[E].position=this._getPoint(arguments[0]),this[E].orientation=this._getPoint(arguments[1])}if(this[E].matrix){let r=p();e=r,t=this[E].matrix,e[0]=t[12],e[1]=t[13],e[2]=t[14],this[E].position=DOMPointReadOnly.fromPoint({x:r[0],y:r[1],z:r[2]});let i=w();!function(e,t){let r=t[0]+t[5]+t[10],i=0;r>0?(i=2*Math.sqrt(r+1),e[3]=.25*i,e[0]=(t[6]-t[9])/i,e[1]=(t[8]-t[2])/i,e[2]=(t[1]-t[4])/i):t[0]>t[5]&&t[0]>t[10]?(i=2*Math.sqrt(1+t[0]-t[5]-t[10]),e[3]=(t[6]-t[9])/i,e[0]=.25*i,e[1]=(t[1]+t[4])/i,e[2]=(t[8]+t[2])/i):t[5]>t[10]?(i=2*Math.sqrt(1+t[5]-t[0]-t[10]),e[3]=(t[8]-t[2])/i,e[0]=(t[1]+t[4])/i,e[1]=.25*i,e[2]=(t[6]+t[9])/i):(i=2*Math.sqrt(1+t[10]-t[0]-t[5]),e[3]=(t[1]-t[4])/i,e[0]=(t[8]+t[2])/i,e[1]=(t[6]+t[9])/i,e[2]=.25*i)}(i,this[E].matrix),this[E].orientation=DOMPointReadOnly.fromPoint({x:i[0],y:i[1],z:i[2],w:i[3]})}else this[E].matrix=d(new Float32Array(16)),function(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3],o=i+i,h=s+s,l=n+n,c=i*o,d=i*h,u=i*l,_=s*h,p=s*l,f=n*l,m=a*o,g=a*h,w=a*l;e[0]=1-(_+f),e[1]=d+w,e[2]=u-g,e[3]=0,e[4]=d-w,e[5]=1-(c+f),e[6]=p+m,e[7]=0,e[8]=u+g,e[9]=p-m,e[10]=1-(c+_),e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1}(this[E].matrix,v(this[E].orientation.x,this[E].orientation.y,this[E].orientation.z,this[E].orientation.w),f(this[E].position.x,this[E].position.y,this[E].position.z));var e,t}_getPoint(e){return e instanceof DOMPointReadOnly?e:DOMPointReadOnly.fromPoint(e)}get matrix(){return this[E].matrix}get position(){return this[E].position}get orientation(){return this[E].orientation}get inverse(){if(null===this[E].inverse){let e=d(new Float32Array(16));u(e,this[E].matrix),this[E].inverse=new R(e),this[E].inverse[E].inverse=this}return this[E].inverse}}const A=Symbol("@@webxr-polyfill/XRViewerPose");class M extends h{constructor(e,t){super(new R,!1),this[A]={device:e,views:t,leftViewMatrix:d(new Float32Array(16)),rightViewMatrix:d(new Float32Array(16)),poseModelMatrix:d(new Float32Array(16))}}get poseModelMatrix(){return this[A].poseModelMatrix}get views(){return this[A].views}_updateFromReferenceSpace(e){const t=this[A].device.getBasePoseMatrix(),r=this[A].device.getBaseViewMatrix("left"),i=this[A].device.getBaseViewMatrix("right");t&&(e._transformBasePoseMatrix(this[A].poseModelMatrix,t),e._adjustForOriginOffset(this[A].poseModelMatrix),super._setTransform(new R(this[A].poseModelMatrix))),r&&(e._transformBaseViewMatrix(this[A].leftViewMatrix,r,this[A].poseModelMatrix),_(this[A].leftViewMatrix,this[A].leftViewMatrix,e._originOffsetMatrix())),i&&(e._transformBaseViewMatrix(this[A].rightViewMatrix,i,this[A].poseModelMatrix),_(this[A].rightViewMatrix,this[A].rightViewMatrix,e._originOffsetMatrix()));for(let e of this[A].views)"left"==e.eye?e._updateViewMatrix(this[A].leftViewMatrix):"right"==e.eye&&e._updateViewMatrix(this[A].rightViewMatrix)}}const x=Symbol("@@webxr-polyfill/XRViewport");class S{constructor(e){this[x]={target:e}}get x(){return this[x].target.x}get y(){return this[x].target.y}get width(){return this[x].target.width}get height(){return this[x].target.height}}const T=["left","right"],I=Symbol("@@webxr-polyfill/XRView");class C{constructor(e,t,r){if(!T.includes(t))throw new Error(`XREye must be one of: ${T}`);const i=Object.create(null),s=new S(i);this[I]={device:e,eye:t,viewport:s,temp:i,sessionId:r,transform:null}}get eye(){return this[I].eye}get projectionMatrix(){return this[I].device.getProjectionMatrix(this.eye)}get transform(){return this[I].transform}_updateViewMatrix(e){let t=d(new Float32Array(16));u(t,e),this[I].transform=new R(t)}_getViewport(e){if(this[I].device.getViewport(this[I].sessionId,this.eye,e,this[I].temp))return this[I].viewport}}var P=1e-6,O="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function N(){var e=new O(3);return O!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function F(e,t,r){var i=new O(3);return i[0]=e,i[1]=t,i[2]=r,i}function L(e,t,r){var i=t[0],s=t[1],n=t[2],a=r[0],o=r[1],h=r[2];return e[0]=s*h-n*o,e[1]=n*a-i*h,e[2]=i*o-s*a,e}var V,D=function(e){var t=e[0],r=e[1],i=e[2];return Math.sqrt(t*t+r*r+i*i)};V=N();!function(){var e,t=(e=new O(4),O!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e)}();function k(){var e=new O(4);return O!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function G(e,t,r,i){var s=t[0],n=t[1],a=t[2],o=t[3],h=r[0],l=r[1],c=r[2],d=r[3],u=void 0,_=void 0,p=void 0,f=void 0,m=void 0;return(_=s*h+n*l+a*c+o*d)<0&&(_=-_,h=-h,l=-l,c=-c,d=-d),1-_>P?(u=Math.acos(_),p=Math.sin(u),f=Math.sin((1-i)*u)/p,m=Math.sin(i*u)/p):(f=1-i,m=i),e[0]=f*s+m*h,e[1]=f*n+m*l,e[2]=f*a+m*c,e[3]=f*o+m*d,e}var X,W,U,B,H,j,q,z=function(e,t){var r=t[0],i=t[1],s=t[2],n=t[3],a=r*r+i*i+s*s+n*n;return a>0&&(a=1/Math.sqrt(a),e[0]=r*a,e[1]=i*a,e[2]=s*a,e[3]=n*a),e};X=N(),W=F(1,0,0),U=F(0,1,0),B=k(),H=k(),j=new O(9),O!=Float32Array&&(j[1]=0,j[2]=0,j[3]=0,j[5]=0,j[6]=0,j[7]=0),j[0]=1,j[4]=1,j[8]=1,q=j;!function(){var e,t=(e=new O(2),O!=Float32Array&&(e[0]=0,e[1]=0),e)}();const K=Symbol("@@webxr-polyfill/XRFrame");class Y{constructor(e,t,r){const i=[new C(e,"left",r)];t.immersive&&i.push(new C(e,"right",r)),this[K]={device:e,viewerPose:new M(e,i),views:i,session:t}}get session(){return this[K].session}getViewerPose(e){return this[K].viewerPose._updateFromReferenceSpace(e),this[K].viewerPose}getPose(e,t){if("viewer"===e._specialType){let e=this.getViewerPose(t);return new XRPose(new XRRigidTransform(e.poseModelMatrix),e.emulatedPosition)}return"target-ray"===e._specialType||"grip"===e._specialType?this[K].device.getInputPose(e._inputSource,t,e._specialType):null}}const $=Symbol("@@webxr-polyfill/XRSpace");class Z{constructor(e=null,t=null){this[$]={specialType:e,inputSource:t}}get _specialType(){return this[$].specialType}get _inputSource(){return this[$].inputSource}}const J=1.6,Q=Symbol("@@webxr-polyfill/XRReferenceSpace"),ee=["viewer","local","local-floor","bounded-floor","unbounded"];class te extends Z{constructor(e,t,r){if(!ee.includes(t))throw new Error(`XRReferenceSpaceType must be one of ${ee}`);if(super("viewer"===t?"viewer":null),"bounded-floor"===t&&!r)throw new Error("XRReferenceSpace cannot use 'bounded-floor' type if the platform does not provide the floor level");(function(e){return"bounded-floor"===e||"local-floor"===e})(t)&&!r&&((r=d(new Float32Array(16)))[13]=J),r||(r=d(new Float32Array(16))),this[Q]={type:t,transform:r,device:e,originOffset:d(new Float32Array(16))}}_transformBasePoseMatrix(e,t){_(e,this[Q].transform,t)}_transformBaseViewMatrix(e,t){u(e,this[Q].transform),_(e,t,e)}_originOffsetMatrix(){return this[Q].originOffset}_adjustForOriginOffset(e){let t=d(new Float32Array(16));u(t,this[Q].originOffset),_(e,t,e)}getOffsetReferenceSpace(e){let t=new te(this[Q].device,this[Q].type,this[Q].transform,this[Q].bounds);return _(t[Q].originOffset,this[Q].originOffset,e.matrix),t}}const re=Symbol("@@webxr-polyfill/polyfilled-xr-compatible"),ie=Symbol("@@webxr-polyfill/xr-compatible"),se=Symbol("@@webxr-polyfill/XRWebGLLayer"),ne=Object.freeze({antialias:!0,depth:!1,stencil:!1,alpha:!0,multiview:!1,ignoreDepthValues:!1,framebufferScaleFactor:1});const ae=Symbol("@@webxr-polyfill/XRInputSourceEvent");class oe extends Event{constructor(e,t){super(e,t),this[ae]={frame:t.frame,inputSource:t.inputSource}}get frame(){return this[ae].frame}get inputSource(){return this[ae].inputSource}}const he=Symbol("@@webxr-polyfill/XRSessionEvent");class le extends Event{constructor(e,t){super(e,t),this[he]={session:t.session}}get session(){return this[he].session}}const ce=Symbol("@@webxr-polyfill/XRSession");class de extends r{constructor(e,t,r){super();let i="inline"!=t;this[ce]={device:e,mode:t,immersive:i,outputContext:null,ended:!1,suspended:!1,suspendedCallback:null,id:r,activeRenderState:null,pendingRenderState:null};const s=new Y(e,this,this[ce].id);this[ce].frame=s,this[ce].onPresentationEnd=(t=>{if(t!==this[ce].id){this[ce].suspended=!1,this.dispatchEvent("focus",{session:this});const e=this[ce].suspendedCallback;return this[ce].suspendedCallback=null,void(e&&this.requestAnimationFrame(e))}this[ce].ended=!0,e.removeEventListener("@webvr-polyfill/vr-present-end",this[ce].onPresentationEnd),e.removeEventListener("@webvr-polyfill/vr-present-start",this[ce].onPresentationStart),e.removeEventListener("@@webvr-polyfill/input-select-start",this[ce].onSelectStart),e.removeEventListener("@@webvr-polyfill/input-select-end",this[ce].onSelectEnd),this.dispatchEvent("end",new le("end",{session:this}))}),e.addEventListener("@@webxr-polyfill/vr-present-end",this[ce].onPresentationEnd),this[ce].onPresentationStart=(e=>{e!==this[ce].id&&(this[ce].suspended=!0,this.dispatchEvent("blur",{session:this}))}),e.addEventListener("@@webxr-polyfill/vr-present-start",this[ce].onPresentationStart),this[ce].onSelectStart=(e=>{e.sessionId===this[ce].id&&this.dispatchEvent("selectstart",new oe("selectstart",{frame:this[ce].frame,inputSource:e.inputSource}))}),e.addEventListener("@@webxr-polyfill/input-select-start",this[ce].onSelectStart),this[ce].onSelectEnd=(e=>{e.sessionId===this[ce].id&&(this.dispatchEvent("selectend",new oe("selectend",{frame:this[ce].frame,inputSource:e.inputSource})),this.dispatchEvent("select",new oe("select",{frame:this[ce].frame,inputSource:e.inputSource})))}),e.addEventListener("@@webxr-polyfill/input-select-end",this[ce].onSelectEnd),this.onblur=void 0,this.onfocus=void 0,this.onresetpose=void 0,this.onend=void 0,this.onselect=void 0,this.onselectstart=void 0,this.onselectend=void 0}get renderState(){return this[ce].activeRenderState}get immersive(){return this[ce].immersive}get outputContext(){return this[ce].outputContext}get depthNear(){return this[ce].device.depthNear}set depthNear(e){this[ce].device.depthNear=e}get depthFar(){return this[ce].device.depthFar}set depthFar(e){this[ce].device.depthFar=e}get environmentBlendMode(){return this[ce].device.environmentBlendMode||"opaque"}get baseLayer(){return this[ce].baseLayer}set baseLayer(e){this[ce].ended||(this[ce].baseLayer=e,this[ce].device.onBaseLayerSet(this[ce].id,e))}async requestReferenceSpace(e){if(this[ce].ended)return;if("unbounded"===e)throw new NotSupportedError(`The WebXR polyfill does not support the ${e} reference space`);if(!ee.includes(e))throw new TypeError(`XRReferenceSpaceType must be one of ${ee}`);let t=await this[ce].device.requestFrameOfReferenceTransform(e);if("bounded-floor"===e){if(!t)throw new NotSupportedError(`${e} XRReferenceSpace not supported by this device.`);if(!this[ce].device.requestStageBounds())throw new NotSupportedError(`${e} XRReferenceSpace not supported by this device.`);throw new NotSupportedError(`The WebXR polyfill does not support the ${e} reference space yet.`)}return new te(this[ce].device,e,t)}requestAnimationFrame(e){if(!(this[ce].ended||this[ce].suspended&&this[ce].suspendedCallback))return this[ce].suspended&&!this[ce].suspendedCallback&&(this[ce].suspendedCallback=e),this[ce].device.requestAnimationFrame(()=>{null!==this[ce].pendingRenderState&&(this[ce].activeRenderState=this[ce].pendingRenderState,this[ce].pendingRenderState=null,this[ce].activeRenderState.baseLayer&&this[ce].device.onBaseLayerSet(this[ce].id,this[ce].activeRenderState.baseLayer),this[ce].activeRenderState.inlineVerticalFieldOfView&&this[ce].device.onInlineVerticalFieldOfViewSet(this[ce].id,this[ce].activeRenderState.inlineVerticalFieldOfView)),this[ce].device.onFrameStart(this[ce].id),e(a(),this[ce].frame),this[ce].device.onFrameEnd(this[ce].id)})}cancelAnimationFrame(e){this[ce].ended||this[ce].device.cancelAnimationFrame(e)}get inputSources(){return this[ce].device.getInputSources()}async end(){if(!this[ce].ended)return this.immersive||(this[ce].ended=!0,this[ce].device.removeEventListener("@@webvr-polyfill/vr-present-start",this[ce].onPresentationStart),this[ce].device.removeEventListener("@@webvr-polyfill/vr-present-end",this[ce].onPresentationEnd),this[ce].device.removeEventListener("@@webvr-polyfill/input-select-start",this[ce].onSelectStart),this[ce].device.removeEventListener("@@webvr-polyfill/input-select-end",this[ce].onSelectEnd),this.dispatchEvent("end",new le("end",{session:this}))),this[ce].device.endSession(this[ce].id)}updateRenderState(e){if(this[ce].ended){throw new Error("Can't call updateRenderState on an XRSession that has already ended.")}if(e.baseLayer&&e.baseLayer._session!==this){throw new Error("Called updateRenderState with a base layer that was created by a different session.")}if(null!==e.inlineVerticalFieldOfView&&void 0!==e.inlineVerticalFieldOfView){if(this[ce].immersive){throw new Error("inlineVerticalFieldOfView must not be set for an XRRenderState passed to updateRenderState for an immersive session.")}e.inlineVerticalFieldOfView=Math.min(3.13,Math.max(.01,e.inlineVerticalFieldOfView))}null===this[ce].pendingRenderState&&(this[ce].pendingRenderState=Object.assign({},this[ce].activeRenderState,e))}}const ue=Symbol("@@webxr-polyfill/XRInputSource");const _e=Symbol("@@webxr-polyfill/XRInputSourcesChangeEvent");const pe=Symbol("@@webxr-polyfill/XRReferenceSpaceEvent");const fe=Symbol("@@webxr-polyfill/XRRenderState"),me=Object.freeze({depthNear:.1,depthFar:1e3,inlineVerticalFieldOfView:null,baseLayer:null});var ge={XR:class extends r{constructor(e){super(),this[i]={device:null,devicePromise:e,immersiveSession:null,inlineSessions:new Set},e.then(e=>{this[i].device=e})}async isSessionSupported(e){return this[i].device||await this[i].devicePromise,"inline"!=e?Promise.resolve(this[i].device.isSessionSupported(e)):Promise.resolve(!0)}async requestSession(e,t){if(!this[i].device){if("inline"!=e)throw new Error(s);await this[i].devicePromise}const r=await this[i].device.requestSession(e,t),n=new XRSession(this[i].device,e,r);"inline"==e?this[i].inlineSessions.add(n):this[i].immersiveSession=n;const a=()=>{"inline"==e?this[i].inlineSessions.delete(n):this[i].immersiveSession=null,n.removeEventListener("end",a)};return n.addEventListener("end",a),n}},XRSession:de,XRSessionEvent:le,XRFrame:Y,XRView:C,XRViewport:S,XRViewerPose:M,XRWebGLLayer:class{constructor(e,t,r={}){const i=Object.assign({},ne,r);if(!(e instanceof de))throw new Error("session must be a XRSession");if(e.ended)throw new Error("InvalidStateError");if(t[re]&&!0!==t[ie])throw new Error("InvalidStateError");const s=t.getParameter(t.FRAMEBUFFER_BINDING);this[se]={context:t,config:i,framebuffer:s,session:e}}get context(){return this[se].context}get antialias(){return this[se].config.antialias}get ignoreDepthValues(){return!0}get framebuffer(){return this[se].framebuffer}get framebufferWidth(){return this[se].context.drawingBufferWidth}get framebufferHeight(){return this[se].context.drawingBufferHeight}get _session(){return this[se].session}getViewport(e){return e._getViewport(this)}},XRSpace:Z,XRReferenceSpace:te,XRReferenceSpaceEvent:class extends Event{constructor(e,t){super(e,t),this[pe]={referenceSpace:t.referenceSpace,transform:t.transform||null}}get referenceSpace(){return this[pe].referenceSpace}get transform(){return this[pe].transform}},XRInputSource:class{constructor(e){this[ue]={impl:e,gripSpace:new Z("grip",this),targetRaySpace:new Z("target-ray",this)}}get handedness(){return this[ue].impl.handedness}get targetRayMode(){return this[ue].impl.targetRayMode}get gripSpace(){let e=this[ue].impl.targetRayMode;return"gaze"===e||"screen"===e?null:this[ue].gripSpace}get targetRaySpace(){return this[ue].targetRaySpace}get profiles(){return this[ue].impl.profiles}get gamepad(){return this[ue].impl.gamepad}},XRInputSourceEvent:oe,XRInputSourcesChangeEvent:class extends Event{constructor(e,t){super(e,t),this[_e]={session:t.session,added:t.added,removed:t.removed}}get session(){return this[_e].session}get added(){return this[_e].added}get removed(){return this[_e].removed}},XRRenderState:class{constructor(e={}){const t=Object.assign({},me,e);this[fe]={config:t}}get depthNear(){return this[fe].depthNear}get depthFar(){return this[fe].depthFar}get inlineVerticalFieldOfView(){return this[fe].inlineVerticalFieldOfView}get baseLayer(){return this[fe].baseLayer}},XRRigidTransform:R,XRPose:h};const we=e=>"function"!=typeof e.prototype.makeXRCompatible&&(e.prototype.makeXRCompatible=function(){return this[ie]=!0,Promise.resolve()},!0),be=e=>{const t=e.prototype.getContext;e.prototype.getContext=function(e,r){const i=t.call(this,e,r);return i&&(i[re]=!0,r&&"xrCompatible"in r&&(i[ie]=r.xrCompatible)),i}},ve=async function(e,t){return null},ye={global:e,webvr:!0,cardboard:!0,cardboardConfig:null,allowCardboardOnDesktop:!1},Ee=["navigator","HTMLCanvasElement","WebGLRenderingContext"];class Re{constructor(e={}){this.config=Object.freeze(Object.assign({},ye,e)),this.global=this.config.global,this.nativeWebXR="xr"in this.global.navigator,this.injected=!1,this.nativeWebXR?this._injectCompatibilityShims(this.global):this._injectPolyfill(this.global)}_injectPolyfill(e){if(!Ee.every(t=>!!e[t]))throw new Error(`Global must have the following attributes : ${Ee}`);for(const t of Object.keys(ge))void 0!==e[t]?console.warn(`${t} already defined on global.`):e[t]=ge[t];we(e.WebGLRenderingContext)&&(be(e.HTMLCanvasElement),e.OffscreenCanvas&&be(e.OffscreenCanvas),e.WebGL2RenderingContext&&we(e.WebGL2RenderingContext));this.injected=!0,this._patchNavigatorXR()}_patchNavigatorXR(){let e=ve(this.global,this.config);this.xr=new XR(e),Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})}_injectCompatibilityShims(e){if(!Ee.every(t=>!!e[t]))throw new Error(`Global must have the following attributes : ${Ee}`);if(e.navigator.xr&&"supportsSession"in e.navigator.xr&&!("isSessionSupported"in e.navigator.xr)){let t=e.navigator.xr.supportsSession;e.navigator.xr.isSessionSupported=function(e){return t.call(this,e).then(()=>!0).catch(()=>!1)},e.navigator.xr.supportsSession=function(e){return console.warn("navigator.xr.supportsSession() is deprecated. Please call navigator.xr.isSessionSupported() instead and check the boolean value returned when the promise resolves."),t.call(this,e)}}if(e.XRWebGLLayer){let r=e.navigator.xr.requestSession;e.navigator.xr.requestSession=function(e,t){return r.call(this,e,t).then(t=>(t._session_mode=e,t))};var t=e.XRWebGLLayer;e.XRWebGLLayer=function(e,r,i){return i||(i={}),i.compositionDisabled="inline"===e._session_mode,new t(e,r,i)}}}}const Ae=1e-6;let Me="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function xe(){let e=new Me(16);return Me!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function Se(e){let t=new Me(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function Te(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Ie(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Ce(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],d=t[8],u=t[9],_=t[10],p=t[11],f=t[12],m=t[13],g=t[14],w=t[15],b=r[0],v=r[1],y=r[2],E=r[3];return e[0]=b*i+v*o+y*d+E*f,e[1]=b*s+v*h+y*u+E*m,e[2]=b*n+v*l+y*_+E*g,e[3]=b*a+v*c+y*p+E*w,b=r[4],v=r[5],y=r[6],E=r[7],e[4]=b*i+v*o+y*d+E*f,e[5]=b*s+v*h+y*u+E*m,e[6]=b*n+v*l+y*_+E*g,e[7]=b*a+v*c+y*p+E*w,b=r[8],v=r[9],y=r[10],E=r[11],e[8]=b*i+v*o+y*d+E*f,e[9]=b*s+v*h+y*u+E*m,e[10]=b*n+v*l+y*_+E*g,e[11]=b*a+v*c+y*p+E*w,b=r[12],v=r[13],y=r[14],E=r[15],e[12]=b*i+v*o+y*d+E*f,e[13]=b*s+v*h+y*u+E*m,e[14]=b*n+v*l+y*_+E*g,e[15]=b*a+v*c+y*p+E*w,e}function Pe(e,t){let r=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=r,e[2]=0,e[3]=0,e[4]=-r,e[5]=i,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Oe(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function Ne(e,t){let r=t[0]+t[5]+t[10],i=0;return r>0?(i=2*Math.sqrt(r+1),e[3]=.25*i,e[0]=(t[6]-t[9])/i,e[1]=(t[8]-t[2])/i,e[2]=(t[1]-t[4])/i):t[0]>t[5]&&t[0]>t[10]?(i=2*Math.sqrt(1+t[0]-t[5]-t[10]),e[3]=(t[6]-t[9])/i,e[0]=.25*i,e[1]=(t[1]+t[4])/i,e[2]=(t[8]+t[2])/i):t[5]>t[10]?(i=2*Math.sqrt(1+t[5]-t[0]-t[10]),e[3]=(t[8]-t[2])/i,e[0]=(t[1]+t[4])/i,e[1]=.25*i,e[2]=(t[6]+t[9])/i):(i=2*Math.sqrt(1+t[10]-t[0]-t[5]),e[3]=(t[1]-t[4])/i,e[0]=(t[8]+t[2])/i,e[1]=(t[6]+t[9])/i,e[2]=.25*i),e}function Fe(){let e=new Me(3);return Me!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function Le(e,t){let r=e[0],i=e[1],s=e[2],n=t[0],a=t[1],o=t[2];return Math.abs(r-n)<=Ae*Math.max(1,Math.abs(r),Math.abs(n))&&Math.abs(i-a)<=Ae*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(s-o)<=Ae*Math.max(1,Math.abs(s),Math.abs(o))}!function(){let e=Fe()}();class Ve extends r{constructor(e,t=null,r=0){super(),this._uid=t||Ve._generateUID(),this._transform=Se(e),this._timestamp=r,this._poseChanged=!0,this._deleted=!1,this._placeholder=!1}get deleted(){return this._deleted}set deleted(e){this._deleted=e}get placeholder(){return this._placeholder}set placeholder(e){this._placeholder=e}isMesh(){return!1}get timeStamp(){return this._timestamp}get changed(){return this._poseChanged}clearChanged(){this._poseChanged=!1}get modelMatrix(){return this._transform}updateModelMatrix(e,t){if(this._timestamp=t,!this._deleted&&!function(e,t){let r=e[0],i=e[1],s=e[2],n=e[3],a=e[4],o=e[5],h=e[6],l=e[7],c=e[8],d=e[9],u=e[10],_=e[11],p=e[12],f=e[13],m=e[14],g=e[15],w=t[0],b=t[1],v=t[2],y=t[3],E=t[4],R=t[5],A=t[6],M=t[7],x=t[8],S=t[9],T=t[10],I=t[11],C=t[12],P=t[13],O=t[14],N=t[15];return Math.abs(r-w)<=Ae*Math.max(1,Math.abs(r),Math.abs(w))&&Math.abs(i-b)<=Ae*Math.max(1,Math.abs(i),Math.abs(b))&&Math.abs(s-v)<=Ae*Math.max(1,Math.abs(s),Math.abs(v))&&Math.abs(n-y)<=Ae*Math.max(1,Math.abs(n),Math.abs(y))&&Math.abs(a-E)<=Ae*Math.max(1,Math.abs(a),Math.abs(E))&&Math.abs(o-R)<=Ae*Math.max(1,Math.abs(o),Math.abs(R))&&Math.abs(h-A)<=Ae*Math.max(1,Math.abs(h),Math.abs(A))&&Math.abs(l-M)<=Ae*Math.max(1,Math.abs(l),Math.abs(M))&&Math.abs(c-x)<=Ae*Math.max(1,Math.abs(c),Math.abs(x))&&Math.abs(d-S)<=Ae*Math.max(1,Math.abs(d),Math.abs(S))&&Math.abs(u-T)<=Ae*Math.max(1,Math.abs(u),Math.abs(T))&&Math.abs(_-I)<=Ae*Math.max(1,Math.abs(_),Math.abs(I))&&Math.abs(p-C)<=Ae*Math.max(1,Math.abs(p),Math.abs(C))&&Math.abs(f-P)<=Ae*Math.max(1,Math.abs(f),Math.abs(P))&&Math.abs(m-O)<=Ae*Math.max(1,Math.abs(m),Math.abs(O))&&Math.abs(g-N)<=Ae*Math.max(1,Math.abs(g),Math.abs(N))}(this._transform,e)){this._poseChanged=!0;for(var r=0;r<16;r++)this._transform[r]=e[r];try{this.dispatchEvent("update",{source:this})}catch(e){console.error("XRAnchor update event error",e)}}}notifyOfRemoval(){try{this.dispatchEvent("remove",{source:this})}catch(e){console.error("XRAnchor removed event error",e)}}get position(){return Oe(new Float32Array(3),this._poseMatrix)}get orientation(){return Ne(new Float32Array(4),this._poseMatrix)}get uid(){return this._uid}static _generateUID(){return"anchor-"+(new Date).getTime()+"-"+Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}}class De extends Ve{constructor(e,t=null){super(t,null),this._anchor=e,this._timestamp=e.timeStamp,this._tempArray=new Float32Array(16),this._offsetMatrix=xe(),t&&Te(this._offsetMatrix,t),Ce(this._transform,e.modelMatrix,this._offsetMatrix),this._handleAnchorUpdateListener=this._handleAnchorUpdate.bind(this),this._notifyOfRemovalListener=this.notifyOfRemoval.bind(this),this._handleReplaceAnchorListener=this._handleReplaceAnchor.bind(this),e.addEventListener("update",this._handleAnchorUpdateListener),e.addEventListener("removal",this._notifyOfRemovalListener),e.addEventListener("replaceAnchor",this._handleReplaceAnchorListener)}_handleReplaceAnchor(e){this._anchor.removeEventListener("update",this._handleAnchorUpdateListener),this._anchor.removeEventListener("removal",this._notifyOfRemovalListener),this._anchor.removeEventListener("replaceAnchor",this._handleReplaceAnchorListener),this._anchor=e,this._anchor.addEventListener("update",this._handleAnchorUpdateListener),this._anchor.addEventListener("removal",this._notifyOfRemovalListener),this._anchor.addEventListener("replaceAnchor",this._handleReplaceAnchorListener)}_handleAnchorUpdate(){Ce(this._tempArray,this._anchor.modelMatrix,this._offsetMatrix),this.updateModelMatrix(this._tempArray,Math.max(this._anchor.timeStamp,this._timestamp))}get modelMatrix(){return this._transform}clearChanged(){super.clearChanged()}get anchor(){return this._anchor}get offsetMatrix(){return this._offsetMatrix}set offsetMatrix(e){Te(this._offsetMatrix,e),this._handleAnchorUpdate()}}var ke=!1;class Ge extends Ve{static setUseGeomArrays(){ke=!0}static useGeomArrays(){return ke}constructor(e,t,r=null,i=0){super(e,r,i),this._useGeomArrays=ke,this._vertexCountChanged=!0,this._vertexPositionsChanged=!0,this._triangleIndicesChanged=!0,this._textureCoordinatesChanged=!0,this._vertexPositions=[],this._triangleIndices=[],this._textureCoordinates=[],this._vertexNormalsChanged=!0,this._vertexNormals=[],t&&(this._geometry=t,this._updateGeometry(this._geometry))}isMesh(){return!0}get changed(){return super.changed||this._vertexPositionsChanged||this._vertexNormalsChanged||this._triangleIndicesChanged||this._vertexCountChanged}clearChanged(){super.clearChanged(),this._vertexPositionsChanged=!1,this._vertexNormalsChanged=!1,this._triangleIndicesChanged=!1,this._vertexCountChanged=!1}get vertexCountChanged(){return this._vertexCountChanged}get vertexPositionsChanged(){return this._vertexPositionsChanged}get triangleIndicesChanged(){this._triangleIndicesChanged}get textureCoordinatesChanged(){this._textureCoordinatesChanged}get vertexNormalsChanged(){this._vertexNormalsChanged}get vertexPositions(){return this._vertexPositions}get vertexNormals(){return this._vertexNormals}get triangleIndices(){return this._triangleIndices}get textureCoordinates(){return this._textureCoordinates}get vertexCount(){return this._vertexPositions.length}get triangleCount(){return this._triangleIndices.length}get hasNormals(){return this._vertexNormals.length>0}get hasTextureCoordinates(){return this._textureCoordinates.length>0}_updateGeometry(e){this._geometry=e;let t=e;if(0==t.vertexCount)return void(this._vertexPositions.length>0&&(this._vertexPositionsChanged=!0,this._vertexNormalsChanged=!0,this._triangleIndicesChanged=!0,this._textureCoordinatesChanged=!0,this._vertexPositions=[],this._vertexNormals=[],this.triangleIndices=[],this._textureCoordinates=[]));if(void 0===t.vertexCount)return void console.warn("bad geometry data passed to XRMesh._updateGeometry: no vertex count",t);let r=0;if(this._vertexPositions.length!=3*t.vertexCount){if(void 0===t.vertices)return void console.warn("bad geometry data passed to XRMesh._updateGeometry: no vertices",t);this._vertexCountChanged=!0,this._vertexPositionsChanged=!0,this._vertexPositions=new Float32Array(3*t.vertexCount),t.textureCoordinates&&(this._textureCoordinatesChanged=!0,this._textureCoordinates=new Float32Array(2*t.vertexCount))}else if(this._useGeomArrays)this._vertexPositionsChanged=void 0!==t.vertices&&!Ge.arrayFuzzyEquals(this._vertexPositions,t.vertices),this._textureCoordinatesChanged=void 0!==t.textureCoordinates&&!Ge.arrayFuzzyEquals(this._textureCoordinates,t.textureCoordinates);else{if(this._vertexPositionsChanged=!1,t.vertices){r=0;for(var i=0,s=t.vertexCount;i<s;i++)if(Math.abs(this._vertexPositions[r++]-t.vertices[i].x)>Ae||Math.abs(this._vertexPositions[r++]-t.vertices[i].y)>Ae||Math.abs(this._vertexPositions[r++]-t.vertices[i].z)>Ae){this._vertexPositionsChanged=!0;break}}if(this._textureCoordinatesChanged=!1,t.textureCoordinates){r=0;for(i=0,s=t.vertexCount;i<s;i++)if(Math.abs(this._textureCoordinates[r++]-t.textureCoordinates[i].x)>Ae||Math.abs(this._textureCoordinates[r++]-t.textureCoordinates[i].x)>Ae){this._textureCoordinatesChanged=!0;break}}}if(t.triangleCount?this._triangleIndices.length!=3*t.triangleCount?(this._triangleIndicesChanged=!0,this._triangleIndices=(Ge.arrayMax(t.triangleIndices),new Uint32Array(3*t.triangleCount))):this._triangleIndicesChanged=t.triangleIndicies&&!Ge.arrayEquals(this._triangleIndices,t.triangleIndices):this._triangleIndicesChanged=!1,this._vertexPositionsChanged)if(this._useGeomArrays)this._vertexPositions.set(t.vertices);else{r=0;for(let e of t.vertices)this._vertexPositions[r++]=e.x,this._vertexPositions[r++]=e.y,this._vertexPositions[r++]=e.z}if(this._textureCoordinatesChanged)if(r=0,this._useGeomArrays)this._textureCoordinates.set(t.textureCoordinates);else for(let e of t.textureCoordinates)this._textureCoordinates[r++]=e.x,this._textureCoordinates[r++]=e.y;this._triangleIndicesChanged&&this._triangleIndices.set(t.triangleIndices)}static arrayMax(e){if(0===e.length)return-1/0;for(var t=e[0],r=1,i=e.length;r<i;++r)e[r]>t&&(t=e[r]);return t}static arrayEquals(e,t){if(!e||!t)return!1;if(e.length!=t.length)return!1;for(var r=0,i=e.length;r<i;r++)if(e[r]!=t[r])return!1;return!0}static arrayFuzzyEquals(e,t){if(!e||!t)return!1;if(e.length!=t.length)return!1;for(var r=0,i=e.length;r<i;r++)if(Math.abs(e[r]-t[r])>Ae)return!1;return!0}}class Xe extends Ge{constructor(e,t,r,i=null,s=0){super(e,t,i,s),this._blendShapes={},this._blendShapesChanged=!0,this._updateBlendShapes(r)}get changed(){return super.changed||this._blendShapesChanged}clearChanged(){super.clearChanged(),this._blendShapesChanged=!1}_updateBlendShapes(e){for(let i=0;i<We.length;i++){let s=We[i];var t=this._blendShapes[s],r=e[i];Math.abs(t-r)>Ae&&(this._blendShapesChanged=!0,this._blendShapes[s]=r)}}updateFaceData(e,t,r,i){super.updateModelMatrix(e,i),void 0===t.vertexCount&&(t.vertexCount=t.vertices.length/(Ge.useGeomArrays()?3:1)),this._updateGeometry(t),this._updateBlendShapes(r)}get blendShapes(){return this._blendShapes}}const We=["browDownLeft","browDownRight","browInnerUp","browOuterUpLeft","browOuterUpRight","cheekPuff","cheekSquintLeft","cheekSquintRight","eyeBlinkLeft","eyeBlinkRight","eyeLookDownLeft","eyeLookDownRight","eyeLookInLeft","eyeLookInRight","eyeLookOutLeft","eyeLookOutRight","eyeLookUpLeft","eyeLookUpRight","eyeSquintLeft","eyeSquintRight","eyeWideLeft","eyeWideRight","jawForward","jawLeft","jawOpen","jawRight","mouthClose","mouthDimpleLeft","mouthDimpleRight","mouthFrownLeft","mouthFrownRight","mouthFunnel","mouthLeft","mouthLowerDownLeft","mouthLowerDownRight","mouthPressLeft","mouthPressRight","mouthPucker","mouthRight","mouthRollLower","mouthRollUpper","mouthShrugLower","mouthShrugUpper","mouthSmileLeft","mouthSmileRight","mouthStretchLeft","mouthStretchRight","mouthUpperUpLeft","mouthUpperUpRight","noseSneerLeft","noseSneerRight"];class Ue{constructor(e=null,t=null,r){this._hit=t,this._timestamp=r,this._hitMatrix=Se(e)}get hitMatrix(){return this._hitMatrix}get timeStamp(){return this._timestamp}}class Be extends Ve{}const He=Symbol("@@webxr-polyfill/XRLightProbe");class je{constructor(e={}){this[He]={indirectIrradiance:e.indirectIrradiance}}get indirectIrradiance(){return this[He].indirectIrradiance}get primaryLightDirection(){throw new Error("Not implemented")}get primaryLightIntensity(){throw new Error("Not implemented")}get sphericalHarmonicsCoefficients(){throw new Error("Not implemented")}get sphericalHarmonicsOrientation(){throw new Error("Not implemented")}}function qe(){let e=new Me(4);return Me!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}!function(){let e=qe()}();class ze extends Ge{constructor(e,t,r,i,s,n=null,a=0){super(e,null,n,a),this._center=t,this._extent=r,this._alignment=i,this._planeFeatureChanged=!0,this._yAxis=function(e,t,r,i){let s=new Me(4);return s[0]=e,s[1]=t,s[2]=r,s[3]=i,s}(0,1,0,0),this._normal=qe(),this._boundaryVerticesChanged=!0,this._boundaryVertices=[],this._geometry=s,this._updateGeometry(this._geometry)}get changed(){return super.changed||this._planeFeatureChanged}clearChanged(){super.clearChanged(),this._planeFeatureChanged=!1}updatePlaneData(e,t,r,i,s,n){super.updateModelMatrix(e,n),Le(this._center,t)&&Le(this._extent,r)&&!this._alignment||(this._center=t,this._extent=r,this._alignment=i,this._planeFeatureChanged=!0),this._updateGeometry(s)}get center(){return this._center}get extent(){return this._extent}get alignment(){return this._alignment}get boundaryVertices(){return this._boundaryVertices}get boundaryVerticesChanged(){return this._boundaryVerticesChanged}get boundaryVertexCount(){return this._boundaryVertices.length}_updateGeometry(e){super._updateGeometry(e);let t=e;const r=function(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3];return e[0]=r[0]*i+r[4]*s+r[8]*n+r[12]*a,e[1]=r[1]*i+r[5]*s+r[9]*n+r[13]*a,e[2]=r[2]*i+r[6]*s+r[10]*n+r[14]*a,e[3]=r[3]*i+r[7]*s+r[11]*n+r[15]*a,e}(this._normal,this._yAxis,this._transform),i=r[0],s=r[1],n=r[2];let a=0;if(this._boundaryVertices.length!=3*t.boundaryVertexCount)this._boundaryVerticesChanged=!0,this._boundaryVertices=new Float32Array(3*t.vertexCount),this._vertexNormalsChanged=!0,this._vertexNormals=new Float32Array(3*t.vertexCount);else if(this._vertexNormalsChanged=Math.abs(this._vertexNormals[0]-i)>Ae||Math.abs(this._vertexNormals[1]-s)>Ae||Math.abs(this._vertexNormals[2]-n)>Ae,this._useGeomArrays)this._vertexPositionsChanged=!Ge.arrayFuzzyEquals(this._boundaryVertices,t.boundaryVertices);else{this._boundaryVerticesChanged=!1,a=0;for(var o=0,h=t.vertexCount;o<h;o++)if(Math.abs(this._boundaryVertices[a++]-t.boundaryVertices[o].x)>Ae||Math.abs(this._boundaryVertices[a++]-t.boundaryVertices[o].y)>Ae||Math.abs(this._boundaryVertices[a++]-t.boundaryVertices[o].z)>Ae){this._boundaryVerticesChanged=!0;break}}if(this._boundaryVerticesChanged)if(this._useGeomArrays)this._boundaryVertices.set(t.boundaryVertices);else{a=0;for(let e of t.boundaryVertices)this._boundaryVertices[a++]=e.x,this._boundaryVertices[a++]=e.y,this._boundaryVertices[a++]=e.z}if(this._vertexNormalsChanged){a=0;for(o=0;o<t.vertexCount;o++)this._vertexNormals[a++]=i,this._vertexNormals[a++]=s,this._vertexNormals[a++]=n}}}class Ke{static decodeLength(e){return e.length/4*3}static decodeArrayBuffer(e,t){var r=e.length/4*3;return t&&t.byteLength==r||(t=new ArrayBuffer(r)),this.decode(e,t),t}static removePaddingChars(e){return 64==this._keyStr.indexOf(e.charAt(e.length-1))?e.substring(0,e.length-1):e}static decode(e,t){e=this.removePaddingChars(e),e=this.removePaddingChars(e);var r,i,s,n,a,o,h,l=parseInt(e.length/4*3,10),c=0,d=0;for(r=t?new Uint8Array(t):new Uint8Array(l),e=e.replace(/[^A-Za-z0-9\+\/\=]/g,""),c=0;c<l;c+=3)i=this._keyStr.indexOf(e.charAt(d++))<<2|(a=this._keyStr.indexOf(e.charAt(d++)))>>4,s=(15&a)<<4|(o=this._keyStr.indexOf(e.charAt(d++)))>>2,n=(3&o)<<6|(h=this._keyStr.indexOf(e.charAt(d++))),r[c]=i,64!=o&&(r[c+1]=s),64!=h&&(r[c+2]=n);return r}static encode(e){var t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=e;e instanceof ArrayBuffer?i=new Uint8Array(arrayBuffer):e instanceof ImageData&&(i=e.data);for(var s,n=e.length,a=n%3,o=n-a,h=0;h<o;h+=3)t+=r[(16515072&(s=i[h]<<16|i[h+1]<<8|i[h+2]))>>18]+r[(258048&s)>>12]+r[(4032&s)>>6]+r[63&s];return 1==a?t+=r[(252&(s=i[o]))>>2]+r[(3&s)<<4]+"==":2==a&&(t+=r[(64512&(s=i[o]<<8|i[o+1]))>>10]+r[(1008&s)>>4]+r[(15&s)<<2]+"="),t}}Ke._keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var Ye=[];class $e{constructor(e,t,r,i){this._buffers=e;for(var s=0;s<e.length;s++)if(e[s]._buffer=e[s].buffer,e[s].buffer=null,e[s]._abCache||"string"!=typeof e[s]._buffer){if(!e[s]._abCache&&e[s]._buffer instanceof ImageData){var n=e[s]._buffer.data;for(l=n.length,c=0;c<Ye.length;c++)if(Ye[c].byteLength==l){e[s]._abCache=Ye[c],Ye.splice(c,1);break}var a=e[s]._abCache?e[s]._abCache:new ArrayBuffer(l);e[s]._abCache=null;for(var o=new Uint8Array(a),h=0;h<l;h++)o[h]=n[h];e[s]._buffer=a}}else for(var l=Ke.decodeLength(e[s]._buffer),c=0;c<Ye.length;c++)if(Ye[c].byteLength==l){e[s]._abCache=Ye[c],Ye.splice(c,1);break}this._pixelFormat=t,this._timestamp=r,this._camera=i}static createFromMessage(e){return new this(e.data.buffers,e.data.pixelFormat,e.data.timestamp,e.data.camera)}numBuffers(){this._buffers.length}buffer(e){if(e>=0&&e<this._buffers.length){var t=this._buffers[e];return t.buffer||("string"==typeof t._buffer?(t._buffer=Ke.decodeArrayBuffer(t._buffer,t._abCache),t._abCache=null,t.buffer=new Uint8Array(t._buffer)):t._buffer instanceof ArrayBuffer?t.buffer=new Uint8Array(t._buffer):t._buffer instanceof ImageData&&(t.buffer=ImageData.data)),t}return null}get pixelFormat(){return this._pixelFormat}get timestamp(){return this._timestamp}get camera(){return this._camera}release(){for(var e=this._buffers,t=0;t<e.length;t++)e[t]._buffer instanceof ArrayBuffer&&e[t]._buffer.byteLength>0&&Ye.push(e[t]._buffer),e[t]._abCache instanceof ArrayBuffer&&e[t]._abCache.byteLength>0&&Ye.push(e[t]._abCache)}postMessageToWorker(e,t){var r=Object.assign({},t||{});r.buffers=this._buffers,r.timestamp=this._timestamp,r.pixelFormat=this._pixelFormat,r.camera=this._camera;for(var i=[],s=0;s<r.buffers.length;s++)r.buffers[s].buffer=r.buffers[s]._buffer,(r.buffers[s]._buffer instanceof ArrayBuffer||r.buffers[s]._buffer instanceof ImageData)&&i.push(r.buffers[s]._buffer),r.buffers[s]._buffer=null,r.buffers[s]._abCache instanceof ArrayBuffer&&i.push(r.buffers[s]._abCache);e.postMessage(r,i)}postReplyMessage(e){var t=Object.assign({},e);t.buffers=this._buffers,t.timestamp=this._timestamp,t.pixelFormat=this._pixelFormat,t.camera=this._camera;for(var r=[],i=0;i<t.buffers.length;i++)t.buffers[i].buffer=null,(t.buffers[i]._buffer instanceof ArrayBuffer||t.buffers[i]._buffer instanceof ImageData)&&(r.push(t.buffers[i]._buffer),t.buffers[i].buffer=t.buffers[i]._buffer),t.buffers[i]._buffer=null,t.buffers[i]._abCache instanceof ArrayBuffer&&r.push(t.buffers[i]._abCache);postMessage(t,r)}}$e.IMAGEFORMAT_RGBA32="RGBA32",$e.IMAGEFORMAT_BGRA32="BGRA32",$e.IMAGEFORMAT_RGB24="RGB24",$e.IMAGEFORMAT_BGR24="BGR24",$e.IMAGEFORMAT_GRAY8="GRAY8",$e.IMAGEFORMAT_YUV444P="YUV444P",$e.IMAGEFORMAT_YUV422P="YUV422P",$e.IMAGEFORMAT_YUV420P="YUV420P",$e.IMAGEFORMAT_YUV420SP_NV12="YUV420SP_NV12",$e.IMAGEFORMAT_YUV420SP_NV21="YUV420SP_NV21",$e.IMAGEFORMAT_HSV="HSV",$e.IMAGEFORMAT_Lab="Lab",$e.IMAGEFORMAT_DEPTH="DEPTH",$e.IMAGEFORMAT_NULL="",$e.IMAGEFORMAT=[$e.IMAGEFORMAT_RGBA32,$e.IMAGEFORMAT_BGRA32,$e.IMAGEFORMAT_RGB24,$e.IMAGEFORMAT_BGR24,$e.IMAGEFORMAT_GRAY8,$e.IMAGEFORMAT_YUV444P,$e.IMAGEFORMAT_YUV422P,$e.IMAGEFORMAT_YUV420P,$e.IMAGEFORMAT_YUV420SP_NV12,$e.IMAGEFORMAT_YUV420SP_NV21,$e.IMAGEFORMAT_HSV,$e.IMAGEFORMAT_Lab,$e.IMAGEFORMAT_DEPTH,$e.IMAGEFORMAT_NULL];var Ze={XRAnchor:Ve,XRAnchorOffset:De,XRFaceMesh:Xe,XRHitResult:Ue,XRImageAnchor:Be,XRLightProbe:je,XRMesh:Ge,XRPlaneMesh:ze,XRVideoFrame:$e};class Je extends r{constructor(e){super(),this.global=e,this.onWindowResize=this.onWindowResize.bind(this),this.global.window.addEventListener("resize",this.onWindowResize),this.environmentBlendMode="opaque"}get depthNear(){throw new Error("Not implemented")}set depthNear(e){throw new Error("Not implemented")}get depthFar(){throw new Error("Not implemented")}set depthFar(e){throw new Error("Not implemented")}onBaseLayerSet(e,t){throw new Error("Not implemented")}onInlineVerticalFieldOfViewSet(e,t){throw new Error("Not implemented")}isSessionSupported(e){throw new Error("Not implemented")}async requestSession(e){throw new Error("Not implemented")}requestAnimationFrame(e){throw new Error("Not implemented")}onFrameStart(e){throw new Error("Not implemented")}onFrameEnd(e){throw new Error("Not implemented")}requestStageBounds(){throw new Error("Not implemented")}async requestFrameOfReferenceTransform(e,t){}cancelAnimationFrame(e){throw new Error("Not implemented")}endSession(e){throw new Error("Not implemented")}getViewport(e,t,r,i){throw new Error("Not implemented")}getProjectionMatrix(e){throw new Error("Not implemented")}getBasePoseMatrix(){throw new Error("Not implemented")}getBaseViewMatrix(e){throw new Error("Not implemented")}getInputSources(){throw new Error("Not implemented")}getInputPose(e,t,r){throw new Error("Not implemented")}onWindowResize(){this.onWindowResize()}}let Qe=function(e,t,r=!0,i=!0){var s,n,a,o,h=0,l=function(){h=!1===r?0:Date.now(),s=null,o=e.apply(n,a),s||(n=a=null)},c=function(){var c=Date.now();h||!1!==r||(h=c);var d=t-(c-h);return n=this,a=arguments,d<=0||d>t?(s&&(clearTimeout(s),s=null),h=c,o=e.apply(n,a),s||(n=a=null)):s||!1===i||(s=setTimeout(l,d)),o};return c.cancel=function(){clearTimeout(s),h=0,s=n=a=null},c};Qe(function(...e){console.log(...e)},1e3);const et=Math.PI/180;class tt extends r{constructor(){if(super(),!1===tt.HasARKit())throw new Error("ARKitWrapper will only work in Mozilla's ARDemo test app");if(void 0!==tt.GLOBAL_INSTANCE)throw new Error("ARKitWrapper is a singleton. Use ARKitWrapper.GetOrCreate() to get the global instance.");this._timestamp=0,this._lightProbe=null,this._deviceId=null,this._isWatching=!1,this._waitingForSessionStart=!1,this._isInitialized=!1,this._rawARData=null,this._rAF_callback=null,this._rAF_callbackParams=[],this._requestedPermissions={cameraAccess:!1,worldAccess:!1},this._currentPermissions={cameraAccess:!1,worldAccess:!1},this._worldSensingState={meshDetectionState:!1},this._worldInformation=null,this._projectionMatrix=new Float32Array(16),this._viewMatrix=new Float32Array(16),this._cameraTransform=new Float32Array(16),this._anchors=new Map,this._anchorOffsets=new Map,this._timeOffsets=[],this._timeOffset=0,this._timeOffsetComputed=!1,this._dataBeforeNext=0,this._worldMappingStatus=tt.WEB_AR_WORLDMAPPING_NOT_AVAILABLE,this._globalCallbacksMap={};let e=["onInit","onData"];for(let t=0;t<e.length;t++)this._generateGlobalCallback(e[t],t);this._defaultOptions={location:!0,camera:!0,objects:!0,light_intensity:!0,computer_vision_data:!1},this._m90=Pe(xe(),90*et),this._m90neg=Pe(xe(),-90*et),this._m180=Pe(xe(),180*et),this._mTemp=xe();let t=[["arkitStartRecording",tt.RECORD_START_EVENT],["arkitStopRecording",tt.RECORD_STOP_EVENT],["arkitDidMoveBackground",tt.DID_MOVE_BACKGROUND_EVENT],["arkitWillEnterForeground",tt.WILL_ENTER_FOREGROUND_EVENT],["arkitInterrupted",tt.INTERRUPTED_EVENT],["arkitInterruptionEnded",tt.INTERRUPTION_ENDED_EVENT],["arkitShowDebug",tt.SHOW_DEBUG_EVENT],["arkitWindowResize",tt.WINDOW_RESIZE_EVENT],["onError",tt.ON_ERROR],["arTrackingChanged",tt.AR_TRACKING_CHANGED]];for(let e=0;e<t.length;e++)window[t[e][0]]=(r=>{r=r||null;try{this.dispatchEvent(t[e][1],new CustomEvent(t[e][1],{source:this,detail:r}))}catch(r){console.error(t[e][0]+" callback error",r)}});window.onComputerVisionData=(e=>{this._onComputerVisionData(e)}),window.setNativeTime=(e=>{this._timeOffsets.push((performance||Date).now()-e.nativeTime),this._timeOffsetComputed=!0,this._timeOffset=0;for(var t=0;t<this._timeOffsets.length;t++)this._timeOffset+=this._timeOffsets[t];this._timeOffset=this._timeOffset/this._timeOffsets.length}),window.userGrantedComputerVisionData=(e=>{this._sessionCameraAccess|=e.granted}),window.userGrantedWorldSensingData=(e=>{this._sessionWorldAccess|=e.granted})}static GetOrCreate(e=null){if(void 0===tt.GLOBAL_INSTANCE){tt.GLOBAL_INSTANCE=new tt;let t={browser:!0,points:!0,focus:!1,rec:!0,rec_time:!0,mic:!1,build:!1,plane:!0,warnings:!0,anchors:!1,debug:!0,statistics:!1},r="object"==typeof(e=e&&"object"==typeof e?e:{}).ui?e.ui:{};e.ui=Object.assign(t,r),e.geometry_arrays=!0,Ge.setUseGeomArrays(),tt.GLOBAL_INSTANCE._sendInit(e)}return tt.GLOBAL_INSTANCE}static HasARKit(){return void 0!==window.webkit}get deviceId(){return this._deviceId}get hasSession(){return this._isWatching}get isInitialized(){return this._isInitialized}_sendInit(e){console.log("----INIT"),window.webkit.messageHandlers.initAR.postMessage({options:e,callback:this._globalCallbacksMap.onInit})}waitForInit(){return new Promise((e,t)=>{if(this._isInitialized)return void e();const r=()=>{this.removeEventListener(tt.INIT_EVENT,r,!1),e()};this.addEventListener(tt.INIT_EVENT,r,!1)})}_onInit(e){this._deviceId=e,this._isInitialized=!0;try{this.dispatchEvent(tt.INIT_EVENT,new CustomEvent(tt.INIT_EVENT,{source:this}))}catch(e){console.error("INIT_EVENT event error",e)}}hitTest(e,t,r=tt.HIT_TEST_TYPE_ALL){return new Promise((i,s)=>{this._isInitialized?window.webkit.messageHandlers.hitTest.postMessage({x:e,y:t,type:r,callback:this._createPromiseCallback("hitTest",i)}):s(new Error("ARKit is not initialized"))})}pickBestHit(e){if(0===e.length)return null;let t=e.filter(e=>e.type!=tt.HIT_TEST_TYPE_FEATURE_POINT),r=t.filter(e=>e.type==tt.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT),i=t.filter(e=>e.type==tt.HIT_TEST_TYPE_EXISTING_PLANE);return r.length?(r=r.sort((e,t)=>e.distance-t.distance))[0]:i.length?(i=i.sort((e,t)=>e.distance-t.distance))[0]:t.length?(t=t.sort((e,t)=>e.distance-t.distance))[0]:e[0]}_addAnchor(e,t){return new Promise((r,i)=>{this._isInitialized?window.webkit.messageHandlers.addAnchor.postMessage({uuid:e,transform:t,callback:this._createPromiseCallback("addAnchor",r)}):i(new Error("ARKit is not initialized"))})}createAnchor(e){return new Promise((t,r)=>{var i=new Ve(e,null,this._timestamp);this._addAnchor(i.uid,e).then(e=>{if(e.error)r(e.error);else{var s=this._anchors.get(e.uuid);s?(s.placeholder=!1,s.deleted=!1,s.updateModelMatrix(e.transform,this._timestamp),t(s)):(this._anchors.set(e.uuid,i),t(i))}}).catch((...e)=>{console.error("could not create anchor",...e),r()})})}createAnchorFromHit(e){return new Promise((t,r)=>{if(e.anchor_transform){let r=this._anchors.get(e.uuid);r||(r=new Ve(e.anchor_transform,e.uuid,this._timestamp),console.log("created dummy anchor from hit test"),r.placeholder=!0,this._anchors.set(e.uuid,r)),t(new De(r,e.local_transform))}else{let r=this._anchors.get(e.uuid);r?(r.placeholder=!1,r.deleted=!1,console.log("hit test resulted in a hit on an existing anchor, without an offset")):(r=new Ve(e.world_transform,e.uuid),console.log("created dummy anchor (not a plane) from hit test"),r.placeholder=!0,this._anchors.set(e.uuid,r)),t(r)}})}removeAnchor(e){let t=this._anchors.get(e.uid);t.placeholder?this._anchors.delete(e.uid):(t&&(t.deleted=!0),!e instanceof De&&window.webkit.messageHandlers.removeAnchors.postMessage([e.uid]))}_createDetectionImage(e,t,r,i,s){return new Promise((n,a)=>{if(!this._isInitialized)return void a(new Error("ARKit is not initialized"));let o=Ke.encode(t);window.webkit.messageHandlers.createImageAnchor.postMessage({uid:e,buffer:o,imageWidth:r,imageHeight:i,physicalWidth:s,callback:this._createPromiseCallback("createImageAnchor",n)})})}createDetectionImage(e,t,r,i,s){return new Promise((n,a)=>{this._createDetectionImage(e,t,r,i,s).then(e=>{e.error?a(e.error):e.created?n():a(null)}).catch((...e)=>{console.error("could not create image",...e),a()})})}_destroyDetectionImage(e){return new Promise((t,r)=>{this._isInitialized?window.webkit.messageHandlers.destroyImageAnchor.postMessage({uid:e,callback:this._createPromiseCallback("destroyImageAnchor",t)}):r(new Error("ARKit is not initialized"))})}destroyDetectionImage(e){return new Promise((t,r)=>{this._destroyDetectionImage(e).then(e=>{e.error?r(e.error):t()}).catch((...e)=>{console.error("could not destroy image",...e),r()})})}_activateDetectionImage(e,t=!1){return new Promise((r,i)=>{this._isInitialized?window.webkit.messageHandlers.activateDetectionImage.postMessage({uid:e,trackable:t,callback:this._createPromiseCallback("activateDetectionImage",r)}):i(new Error("ARKit is not initialized"))})}activateDetectionImage(e,t=!1){return new Promise((r,i)=>{var s=this._anchors.get(e);!s||s.deleted?this._activateDetectionImage(e,t).then(e=>{e.error&&i(e.error),e.activated?(this._createOrUpdateAnchorObject(e.imageAnchor),e.imageAnchor.object.deleted=!1,r(e.imageAnchor.object)):i(null)}).catch((...e)=>{console.error("could not activate image",...e),i()}):r(s)})}_deactivateDetectionImage(e){return new Promise((t,r)=>{this._isInitialized?window.webkit.messageHandlers.deactivateDetectionImage.postMessage({uid:e,callback:this._createPromiseCallback("deactivateDetectionImage",t)}):r(new Error("ARKit is not initialized"))})}deactivateDetectionImage(e){return new Promise((t,r)=>{this._deactivateDetectionImage(e).then(i=>{i.error&&r(i.error);var s=this._anchors.get(e);s&&(console.warn("anchor for image target '"+e+"' still exists after deactivation"),this.removeAnchor(s)),t()}).catch((...e)=>{console.error("could not activate image",...e),r()})})}setNumberOfTrackedImages(e){"number"!=typeof e&&(e=0),window.webkit.messageHandlers.setNumberOfTrackedImages.postMessage({numberOfTrackedImages:e})}_getWorldMap(){return new Promise((e,t)=>{this._isInitialized?window.webkit.messageHandlers.getWorldMap.postMessage({callback:this._createPromiseCallback("getWorldMap",e)}):t(new Error("ARKit is not initialized"))})}getWorldMap(){return new Promise((e,t)=>{this._getWorldMap().then(r=>{if(!0!==r.saved)return null!==r.error?void t(r.error):void t(null);e(r.worldMap)}).catch((...e)=>{console.error("could not get world map",...e),t()})})}setWorldMap(e){return new Promise((t,r)=>{this._isInitialized?window.webkit.messageHandlers.setWorldMap.postMessage({worldMap:e.worldMap,callback:this._createPromiseCallback("setWorldMap",t)}):r(new Error("ARKit is not initialized"))})}getLightProbe(){return new Promise((e,t)=>{this._lightProbe?e(this._lightProbe):t(new Error("Not populated yet"))})}stop(){return new Promise((e,t)=>{this._isWatching?(console.log("----STOP"),window.webkit.messageHandlers.stopAR.postMessage({callback:this._createPromiseCallback("stop",e)})):e()})}watch(e=null){return new Promise((t,r)=>{if(!this._isInitialized)return void r("ARKitWrapper hasn't been initialized yet");if(this._waitingForSessionStart)return void r("ARKitWrapper startSession called, waiting to finish");if(this._isWatching)return void t({cameraAccess:this._sessionCameraAccess,worldAccess:this._sessionWorldAccess,webXRAccess:!0});this._waitingForSessionStart=!0;var i=Object.assign({},this._defaultOptions);null!=e&&(i=Object.assign(i,e)),this._requestedPermissions.cameraAccess=i.videoFrames,this._requestedPermissions.worldAccess=i.worldSensing,i.videoFrames&&(delete i.videoFrames,i.computer_vision_data=!0);const s={options:i,callback:this._createPromiseCallback("requestSession",e=>{e.webXRAccess?(this._waitingForSessionStart=!1,this._isWatching=!0,this._currentPermissions.cameraAccess=e.cameraAccess,this._currentPermissions.worldAccess=e.worldAccess,t(e)):r("user did not give permission to start a webxr session")}),data_callback:this._globalCallbacksMap.onData};console.log("----WATCH"),window.webkit.messageHandlers.requestSession.postMessage(s)})}setUIOptions(e){window.webkit.messageHandlers.setUIOptions.postMessage(e)}_createOrUpdateAnchorObject(e){var t;if(e.plane_center)if(!(t=this._anchors.get(e.uuid))||t.placeholder){var r=new ze(e.transform,e.plane_center,[e.plane_extent.x,e.plane_extent.z],e.plane_alignment,e.geometry,e.uuid,this._timestamp);if(t){try{t.dispatchEvent("replaceAnchor",new CustomEvent("replaceAnchor",{source:t,detail:r}))}catch(e){console.error("replaceAnchor event error",e)}console.log("replaced dummy anchor created from hit test with plane"),this._anchors.delete(e.uuid)}this._anchors.set(e.uuid,r),e.object=r}else t&&(t.updatePlaneData(e.transform,e.plane_center,[e.plane_extent.x,e.plane_extent.y],e.plane_alignment,e.geometry,this._timestamp),e.object=t);else if(!(t=this._anchors.get(e.uuid))||t.placeholder){let r;switch(e.type){case tt.ANCHOR_TYPE_FACE:r=new Xe(e.transform,e.geometry,e.blendShapes,e.uuid,this._timestamp);break;case tt.ANCHOR_TYPE_ANCHOR:r=new Ve(e.transform,e.uuid,this._timestamp);break;case tt.ANCHOR_TYPE_IMAGE:r=new Be(e.transform,e.uuid,this._timestamp)}if(t){try{t.dispatchEvent("replaceAnchor",new CustomEvent("replaceAnchor",{source:t||mesh,detail:r}))}catch(e){console.error("replaceAnchor event error",e)}console.log("replaced dummy anchor created from hit test with new anchor")}this._anchors.set(e.uuid,r),e.object=r}else{switch(t=t,e.type){case tt.ANCHOR_TYPE_FACE:t.updateFaceData(e.transform,e.geometry,e.blendShapes,this._timestamp);break;default:t.updateModelMatrix(e.transform,this._timestamp)}e.object=t}}updateWorldSensingState(e){return e.hasOwnProperty("meshDetectionState")&&this._currentPermissions.worldAccess?this._worldSensingState.meshDetectionState=e.meshDetectionState.enabled||!1:this._worldSensingState.meshDetectionState=!1,this._worldSensingState}getWorldInformation(){if(this._worldInformation)return this._worldInformation;let e={};return this._worldSensingState.meshDetectionState&&(e.meshes=[],this._anchors.forEach(t=>{!t.isMesh()||t.deleted||t.placeholder||e.meshes.push(t)})),this._worldInformation=e,e}get hasData(){return null!==this._rawARData}_getData(e=null){return e?this._rawARData&&void 0!==this._rawARData[e]?this._rawARData[e]:null:this._rawARData}requestAnimationFrame(e,...t){this._rAF_callback=e,this._rAF_callbackParams=t}_do_rAF(){if(this._rAF_callback){var e=this._rAF_callback,t=this._rAF_callbackParams;return this._rAF_callback=null,this._rAF_callbackParams=[],window.requestAnimationFrame((...r)=>{this.startingRender();try{e(...t)}catch(e){console.error("application callback error: ",e)}this.finishedRender()})}}finishedRender(){this._dataBeforeNext=0,this._anchors.forEach(e=>{e.clearChanged()}),window.webkit.messageHandlers.onUpdate.postMessage({})}startingRender(){this._dataBeforeNext}_onData(e){if(this._rawARData=e,this._worldInformation=null,this._timestamp=this._adjustARKitTime(e.timestamp),this._lightProbe=new je({indirectIrradiance:e.light_intensity/1e3}),Te(this._cameraTransform,e.camera_transform),Te(this._viewMatrix,e.camera_view),Te(this._projectionMatrix,e.projection_camera),this._worldMappingStatus=e.worldMappingStatus,e.newObjects.length)for(let r=0;r<e.newObjects.length;r++){const i=e.newObjects[r];var t;(t=this._anchors.get(i.uuid))&&t.deleted&&(t.deleted=!1),this._createOrUpdateAnchorObject(i)}if(e.removedObjects.length)for(let t=0;t<e.removedObjects.length;t++){const r=e.removedObjects[t],i=this._anchors.get(r);i?(i.notifyOfRemoval(),this._anchors.delete(r)):console.error("app signalled removal of non-existant anchor/plane")}if(e.objects.length)for(let t=0;t<e.objects.length;t++){const r=e.objects[t];this._createOrUpdateAnchorObject(r)}try{this.dispatchEvent(tt.WATCH_EVENT,new CustomEvent(tt.WATCH_EVENT,{source:this,detail:this}))}catch(e){console.error("WATCH_EVENT event error",e)}this._rAF_callback&&this._do_rAF(),this._dataBeforeNext++}_onStop(){this._isWatching=!1}_adjustARKitTime(e){return this._timeOffsetComputed?e+this._timeOffset:(performance||Date).now()}_createPromiseCallback(e,t){const r=this._generateCallbackUID(e);return window[r]=(i=>{delete window[r];const s="_on"+e[0].toUpperCase()+e.slice(1);"function"==typeof this[s]&&this[s](i),t(i)}),r}_generateCallbackUID(e){return"arkitCallback_"+e+"_"+(new Date).getTime()+"_"+Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}_generateGlobalCallback(e,t){const r="arkitCallback"+t;this._globalCallbacksMap[e]=r;const i=this;window[r]=function(t){i["_"+e](t)}}_onComputerVisionData(e){if(!e)return console.error("detail passed to _onComputerVisionData is null"),void this._requestComputerVisionData();if(!e.frame||!e.frame.buffers||e.frame.buffers.length<=0)return console.error("detail passed to _onComputerVisionData is bad, no buffers"),void this._requestComputerVisionData();e.camera.arCamera=!0;var t=e.camera.interfaceOrientation;switch(e.camera.viewMatrix=e.camera.inverse_viewMatrix,t){case 1:e.camera.cameraOrientation=-90;break;case 2:e.camera.cameraOrientation=90;break;case 3:e.camera.cameraOrientation=0;break;case 4:e.camera.cameraOrientation=180}switch(e.frame.pixelFormatType){case"kCVPixelFormatType_420YpCbCr8BiPlanarFullRange":e.frame.pixelFormat="YUV420P";break;default:e.frame.pixelFormat=e.frame.pixelFormatType}var r=new $e(e.frame.buffers,e.frame.pixelFormat,this._adjustARKitTime(e.frame.timestamp),e.camera);try{this.dispatchEvent(tt.COMPUTER_VISION_DATA,new CustomEvent(tt.COMPUTER_VISION_DATA,{source:this,detail:r}))}catch(e){console.error("COMPUTER_VISION_DATA event error",e)}}_requestComputerVisionData(){window.webkit.messageHandlers.requestComputerVisionData.postMessage({})}_startSendingComputerVisionData(){window.webkit.messageHandlers.startSendingComputerVisionData.postMessage({})}_stopSendingComputerVisionData(){window.webkit.messageHandlers.stopSendingComputerVisionData.postMessage({})}}tt.INIT_EVENT="arkit-init",tt.WATCH_EVENT="arkit-watch",tt.RECORD_START_EVENT="arkit-record-start",tt.RECORD_STOP_EVENT="arkit-record-stop",tt.DID_MOVE_BACKGROUND_EVENT="arkit-did-move-background",tt.WILL_ENTER_FOREGROUND_EVENT="arkit-will-enter-foreground",tt.INTERRUPTED_EVENT="arkit-interrupted",tt.INTERRUPTION_ENDED_EVENT="arkit-interruption-ended",tt.SHOW_DEBUG_EVENT="arkit-show-debug",tt.WINDOW_RESIZE_EVENT="arkit-window-resize",tt.ON_ERROR="on-error",tt.AR_TRACKING_CHANGED="ar_tracking_changed",tt.COMPUTER_VISION_DATA="cv_data",tt.USER_GRANTED_COMPUTER_VISION_DATA="user-granted-cv-data",tt.USER_GRANTED_WORLD_SENSING_DATA="user-granted-world-sensing-data",tt.ORIENTATION_UP=1,tt.ORIENTATION_UP_MIRRORED=2,tt.ORIENTATION_DOWN=3,tt.ORIENTATION_DOWN_MIRRORED=4,tt.ORIENTATION_LEFT_MIRRORED=5,tt.ORIENTATION_RIGHT=6,tt.ORIENTATION_RIGHT_MIRRORED=7,tt.ORIENTATION_LEFT=8,tt.WEB_AR_WORLDMAPPING_NOT_AVAILABLE="ar_worldmapping_not_available",tt.WEB_AR_WORLDMAPPING_LIMITED="ar_worldmapping_limited",tt.WEB_AR_WORLDMAPPING_EXTENDING="ar_worldmapping_extending",tt.WEB_AR_WORLDMAPPING_MAPPED="ar_worldmapping_mapped",tt.HIT_TEST_TYPE_FEATURE_POINT=1,tt.HIT_TEST_TYPE_ESTIMATED_HORIZONTAL_PLANE=2,tt.HIT_TEST_TYPE_ESTIMATED_VERTICAL_PLANE=4,tt.HIT_TEST_TYPE_EXISTING_PLANE=8,tt.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT=16,tt.HIT_TEST_TYPE_EXISTING_PLANE_USING_GEOMETRY=32,tt.HIT_TEST_TYPE_ALL=tt.HIT_TEST_TYPE_FEATURE_POINT|tt.HIT_TEST_TYPE_EXISTING_PLANE|tt.HIT_TEST_TYPE_ESTIMATED_HORIZONTAL_PLANE|tt.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT,tt.HIT_TEST_TYPE_EXISTING_PLANES=tt.HIT_TEST_TYPE_EXISTING_PLANE|tt.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT,tt.ANCHOR_TYPE_PLANE="plane",tt.ANCHOR_TYPE_FACE="face",tt.ANCHOR_TYPE_ANCHOR="anchor",tt.ANCHOR_TYPE_IMAGE="image";class rt{constructor(e){this._subscribed=!1,this._arKitWrapper=e,this.subscribe()}subscribe(){this._subscribed||(this._subscribed=!0,this._arKitWrapper.addEventListener(tt.INIT_EVENT,this.handleARKitInit.bind(this)),this._arKitWrapper.addEventListener(tt.WATCH_EVENT,this.handleARKitUpdate.bind(this)),this._arKitWrapper.addEventListener(tt.WINDOW_RESIZE_EVENT,this.handleARKitWindowResize.bind(this)),this._arKitWrapper.addEventListener(tt.ON_ERROR,this.handleOnError.bind(this)),this._arKitWrapper.addEventListener(tt.AR_TRACKING_CHANGED,this.handleArTrackingChanged.bind(this)),this._arKitWrapper.addEventListener(tt.COMPUTER_VISION_DATA,this.handleComputerVisionData.bind(this)))}handleARKitInit(){}handleARKitUpdate(){}handleARKitWindowResize(){}handleOnError(){}handleArTrackingChanged(){}handleComputerVisionData(){}}class it extends Je{constructor(e){super(e),this._throttledLogPose=Qe(this.logPose,1e3),this._sessions=new Map,this._activeSession=null,this._wrapperDiv=document.createElement("div"),this._wrapperDiv.setAttribute("class","arkit-device-wrapper");const t=()=>{document.body.insertBefore(this._wrapperDiv,document.body.firstChild||null)};document.body?t():document.addEventListener("DOMContentLoaded",e=>t),this._headModelMatrix=xe(),this._projectionMatrix=xe(),this._eyeLevelMatrix=Ie(xe()),this._stageMatrix=Ie(xe()),this._stageMatrix[13]=-1.3,this._baseFrameSet=!1,this._frameOfRefRequestsWaiting=[],this._depthNear=.1,this._depthFar=1e3;try{this._arKitWrapper=tt.GetOrCreate(),this._arWatcher=new at(this._arKitWrapper,this)}catch(e){console.error("Error initializing the ARKit wrapper",e),this._arKitWrapper=null,this._arWatcher=null}}static initStyles(){window.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{try{var e=document.createElement("style");document.head.appendChild(e);var t=e.sheet;t.insertRule(".arkit-device-wrapper { z-index: -1; }",0),t.insertRule(".arkit-device-wrapper, .xr-canvas { position: absolute; top: 0; left: 0; bottom: 0; right: 0; }",0),t.insertRule(".arkit-device-wrapper, .arkit-device-wrapper canvas { width: 100%; height: 100%; padding: 0; margin: 0; -webkit-user-select: none; user-select: none; }",0)}catch(e){console.error("page error",e)}},1)})}get depthNear(){return this._depthNear}set depthNear(e){this._depthNear=e}get depthFar(){return this._depthFar}set depthFar(e){this._depthFar=e}isSessionSupported(e){return"immersive-ar"===e}async requestSession(e,t={}){if(!this.isSessionSupported(e))return console.error("Invalid session mode",e),Promise.reject();if(!this._arKitWrapper)return console.error("Session requested without an ARKitWrapper"),Promise.reject();if(null!==this._activeSession)return console.error("Tried to start a second active session"),Promise.reject();const r=t.requiredFeatures||[],i=t.optionalFeatures||[];var s={};(r.indexOf("worldSensing")>=0||i.indexOf("worldSensing")>=0)&&(s.worldSensing=!0),(r.indexOf("computerVision")>=0||i.indexOf("computerVision")>=0)&&(s.videoFrames=!0),(r.indexOf("alignEUS")>=0||i.indexOf("alignEUS")>=0)&&(s.alignEUS=!0);await this._arKitWrapper.waitForInit().then(()=>{}).catch((...e)=>(console.error("app failed to initialize: ",...e),Promise.reject()));return await this._arKitWrapper.watch(s).then(e=>{const t=new nt;return this._sessions.set(t.id,t),this._activeSession=t,Promise.resolve(t.id)}).catch((...e)=>(console.error("session request failed: ",...e),Promise.reject()))}onBaseLayerSet(e,t){this._sessions.get(e).baseLayer=t,this._wrapperDiv.appendChild(t.context.canvas),t.context.canvas.style.width="100%",t.context.canvas.style.height="100%"}requestAnimationFrame(e,...t){this._arKitWrapper.requestAnimationFrame(e,t)}cancelAnimationFrame(e){return window.cancelAnimationFrame(e)}onFrameStart(e){}onFrameEnd(e){}logPose(){console.log("pose",Oe(new Float32Array(3),this._headModelMatrix),Ne(new Float32Array(4),this._headModelMatrix))}requestFrameOfReferenceTransform(e,t){var r=this;return new Promise((t,i)=>{let s=function(e){r._baseFrameSet?e():r._frameOfRefRequestsWaiting.push(e)};switch(e){case"viewer":return void s(function(){t(r._headModelMatrix)});case"local":return void s(function(){t(r._eyeLevelMatrix)});case"local-floor":case"bounded-floor":case"unbounded":return void i(new Error("not supported",e));default:i(new Error("Unsupported frame of reference type",e))}})}endSession(e){const t=this._sessions.get(e);t&&!t.ended&&(t.ended=!0,this._activeSession===t&&(this._activeSession=null,this._arKitWrapper.stop()),null!==t.baseLayer&&this._wrapperDiv.removeChild(t.baseLayer.context.canvas))}getViewport(e,t,r,i){const{offsetWidth:s,offsetHeight:n}=r.context.canvas;return i.x=0,i.y=0,i.width=s,i.height=n,!0}getProjectionMatrix(e){return this._projectionMatrix}setProjectionMatrix(e){Te(this._projectionMatrix,e)}getBasePoseMatrix(){return this._headModelMatrix}getBaseViewMatrix(e){return this._headModelMatrix}setBaseViewMatrix(e){if(Te(this._headModelMatrix,e),!this._baseFrameSet){this._baseFrameSet=!0;for(let e=0;e<this._frameOfRefRequestsWaiting.length;e++){const t=this._frameOfRefRequestsWaiting[e];try{t()}catch(e){console.error("finalization of reference frame requests failed: ",e)}}this._frameOfRefRequestsWaiting=[]}}requestStageBounds(){return null}getInputSources(){return[]}getInputPose(e,t){return null}onWindowResize(){this._sessions.forEach((e,t)=>{})}}let st=100;class nt{constructor(){this.ended=null,this.baseLayer=null,this.id=++st}}class at extends rt{constructor(e,t){super(e),this._arKitDevice=t}handleARKitUpdate(e){this._arKitDevice.setBaseViewMatrix(this._arKitWrapper._cameraTransform),this._arKitDevice.setProjectionMatrix(this._arKitWrapper._projectionMatrix)}handleOnError(...e){console.error("ARKit error",...e)}}const ot=xe(),ht=xe();Re.prototype._patchNavigatorXR=function(){this.xr=new XR(Promise.resolve(new it(this.global))),this.xr._mozillaXRViewer=!0,Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})};let lt=navigator.userAgent.indexOf("Mobile/");const ct=-1!==navigator.userAgent.indexOf("WebXRViewer")||(-1!==navigator.userAgent.indexOf("iPhone")||-1!==navigator.userAgent.indexOf("iPad"))&&-1!==lt&&-1!==navigator.userAgent.indexOf("AppleWebKit")&&-1===navigator.userAgent.indexOf(" ",lt)?new Re(null,{webvr:!1,cardboard:!1}):null;function dt(e){return At.updateWorldSensingState(e)}function ut(){return At.getWorldInformation()}async function _t(e,t,r){return new Promise((i,s)=>{const n=function(e,t){var r=function(e,t,r){let i=t[0],s=t[1],n=t[2],a=r[3]*i+r[7]*s+r[11]*n+r[15];return a=a||1,e[0]=(r[0]*i+r[4]*s+r[8]*n+r[12])/a,e[1]=(r[1]*i+r[5]*s+r[9]*n+r[13])/a,e[2]=(r[2]*i+r[6]*s+r[10]*n+r[14])/a,e}(Fe(),e,t);let i=(r[0]+1)/2,s=(1-r[1])/2;return[i,s]}(e,At._projectionMatrix);At.hitTest(...n,tt.HIT_TEST_TYPE_EXISTING_PLANE_USING_GEOMETRY).then(e=>{0===e.length&&i([]),this.requestReferenceSpace("local").then(s=>{Te(ot,r.getPose(t,s).transform.matrix),i(e.map(e=>(Ce(ht,ot,e.world_transform),new Ue(ht,e,At._timestamp))))}).catch((...e)=>{console.error("Error testing for hits",...e),s()})}).catch((...e)=>{console.error("Error testing for hits",...e),s()})})}async function pt(e,t,r){return e instanceof Ue?At.createAnchorFromHit(e._hit):e instanceof Float32Array?new Promise((i,s)=>{this.requestReferenceSpace("local").then(n=>{Te(ot,r.getPose(n,t).transform.matrix);const a=Ce(xe(),ot,e);At.createAnchor(a).then(i).catch((...e)=>{console.error("could not create anchor",...e),s()})})}).catch((...e)=>{console.error("could not create eye-level frame of reference",...e),reject()}):Promise.reject("invalid value passed to addAnchor",e)}async function ft(e){return new Promise((t,r)=>{At.removeAnchor(e),t()})}function mt(e){return At.setNumberOfTrackedImages(e)}function gt(e,t,r,i,s){return At.createDetectionImage(e,t,r,i,s)}function wt(e){return At.createDetectionImage(e)}function bt(e){return At.activateDetectionImage(e)}function vt(e){return At.deactivateDetectionImage(e)}function yt(){return At.getWorldMap()}function Et(e){return At.setWorldMap(e)}function Rt(){return At._worldMappingStatus}var At=null;ct&&ct.injected&&function(){if(navigator.xr){At=tt.GetOrCreate(),it.initStyles(),window.XR&&(XR.prototype._isSessionSupported=XR.prototype.isSessionSupported,XR.prototype._requestSession=XR.prototype.requestSession,XR.prototype.isSessionSupported=function(e){return"immersive-ar"!==e?Promise.resolve(!1):this._isSessionSupported(e)},XR.prototype.requestSession=function(e,t){return"immersive-ar"!==e&&Promise.reject(new DOMException("Polyfill Error: only immersive-ar mode is supported.")),this._requestSession(e,t)}),window.XRSession&&(XRSession.prototype.requestHitTest=_t,XRSession.prototype.updateWorldSensingState=dt,XRSession.prototype.addAnchor=pt,XRSession.prototype.removeAnchor=ft,XRSession.prototype.nonStandard_createDetectionImage=gt,XRSession.prototype.nonStandard_destroyDetectionImage=wt,XRSession.prototype.nonStandard_activateDetectionImage=bt,XRSession.prototype.nonStandard_deactivateDetectionImage=vt,XRSession.prototype.nonStandard_setNumberOfTrackedImages=mt,XRSession.prototype.nonStandard_getWorldMap=yt,XRSession.prototype.nonStandard_setWorldMap=Et,XRSession.prototype.nonStandard_getWorldMappingStatus=Rt),window.XRFrame&&(Object.defineProperty(XRFrame.prototype,"worldInformation",{get:ut}),XRFrame.prototype._getPose=window.XRFrame.prototype.getPose,XRFrame.prototype.getPose=function(e,t){if("target-ray"===e._specialType||"grip"===e._specialType)return this._getPose(e,t);const r=this.getViewerPose(t);if(!r)return null;Te(ot,r.transform.matrix);const i=this.getViewerPose(e);if(!i)return null;!function(e,t){let r=t[0],i=t[1],s=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],d=t[9],u=t[10],_=t[11],p=t[12],f=t[13],m=t[14],g=t[15],w=r*o-i*a,b=r*h-s*a,v=r*l-n*a,y=i*h-s*o,E=i*l-n*o,R=s*l-n*h,A=c*f-d*p,M=c*m-u*p,x=c*g-_*p,S=d*m-u*f,T=d*g-_*f,I=u*g-_*m,C=w*I-b*T+v*S+y*x-E*M+R*A;C&&(C=1/C,e[0]=(o*I-h*T+l*S)*C,e[1]=(s*T-i*I-n*S)*C,e[2]=(f*R-m*E+g*y)*C,e[3]=(u*E-d*R-_*y)*C,e[4]=(h*x-a*I-l*M)*C,e[5]=(r*I-s*x+n*M)*C,e[6]=(m*v-p*R-g*b)*C,e[7]=(c*R-u*v+_*b)*C,e[8]=(a*T-o*x+l*A)*C,e[9]=(i*x-r*T-n*A)*C,e[10]=(p*E-f*v+g*w)*C,e[11]=(d*v-c*E-_*w)*C,e[12]=(o*M-a*S-h*A)*C,e[13]=(r*S-i*M+s*A)*C,e[14]=(f*b-p*y-m*w)*C,e[15]=(c*y-d*b+u*w)*C)}(ht,i.transform.matrix);const s=Ce(xe(),ot,ht);return new XRPose(new XRRigidTransform(s),!1)},XRFrame.prototype.getGlobalLightEstimate=function(){return At.getLightProbe()},XRFrame.prototype.getGlobalReflectionProbe=function(){throw new Error("Not implemented")});for(const e of Object.keys(Ze))void 0!==window[e]?console.warn(`${e} already defined on global.`):window[e]=Ze[e]}}()});
